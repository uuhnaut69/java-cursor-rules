<?xml version="1.0" encoding="UTF-8"?>
<prompt xmlns:xi="http://www.w3.org/2001/XInclude">

    <metadata>
        <author>Juan Antonio Breña Moral</author>
        <version>0.10.0</version>
        <title>Add Maven dependencies for improved code quality</title>
    </metadata>

    <role>You are a Senior software engineer with extensive experience in Java software development</role>

    <goal>
        This rule provides a focused approach to adding essential Maven dependencies that enhance code quality and safety, specifically JSpecify for nullness annotations. It asks targeted questions to understand dependency needs and conditionally adds only relevant components.
    </goal>

    <constraints>
        <constraints-description>
            Before applying This Maven dependencies recommendations, ensure the project is in a valid state by running Maven validation.
            This helps identify any existing configuration issues that need to be resolved first.
        </constraints-description>
        <constraint-list>
            <constraint>**MANDATORY**: Run `./mvnw validate` or `mvn validate` before applying any Maven best practices recommendations</constraint>
            <constraint>**VERIFY**: Ensure all validation errors are resolved before proceeding with POM modifications</constraint>
            <constraint>**PREREQUISITE**: Project must compile and pass basic validation checks before optimization</constraint>
            <constraint>**SAFETY**: If validation fails, NOT CONTINUE and ask the user to fix the issues before continuing</constraint>
        </constraint-list>
    </constraints>

    <instructions>
        <steps>
            <step number="1">
                <step-title>Maven Wrapper Check and Installation</step-title>
                <step-content>
                    **First, check for Maven Wrapper files** in the project root
                    - Look for `mvnw` (Unix/Mac) and `mvnw.cmd` (Windows) files
                    - Check for `.mvn/wrapper/` directory with `maven-wrapper.properties`

                    **If Maven Wrapper is NOT present:**

                    **STOP HERE** and ask the user: "I notice this project doesn't have Maven Wrapper configured.
                    The Maven Wrapper ensures everyone uses the same Maven version, improving build consistency across different environments.
                    Would you like me to install it? (y/n)"

                    **WAIT for the user's response. Do NOT proceed to any other questions or steps until this is resolved.**

                    if the user says "y", then install the Maven Wrapper.

                    ```bash
                    mvn wrapper:wrapper
                    ```

                </step-content>
            </step>
            <step number="2">
                <step-title>Dependency Assessment Questions</step-title>
                <step-content>
                    I need to understand what dependencies to add to enhance your project's code quality and safety.
                    I'll ask you a few targeted questions:

                    ```markdown
                    <xi:include href="fragments/java-maven-dependencies-questions-template.md" parse="text"/>
                    ```
                </step-content>
                <step-constraints>
                    <step-constraint-list>
                        <step-constraint>**CRITICAL**: You MUST ask the exact questions from the following template in strict order before making any changes to understand the dependency needs</step-constraint>
                        <step-constraint>**MUST** read template files fresh using file_search and read_file tools before asking any questions</step-constraint>
                        <step-constraint>**MUST NOT** use cached or remembered questions from previous interactions</step-constraint>
                        <step-constraint>**MUST** ask questions ONE BY ONE in the exact order specified in the template</step-constraint>
                        <step-constraint>**MUST** WAIT for user response to each question before proceeding to the next</step-constraint>
                        <step-constraint>**MUST** use the EXACT wording from the template questions</step-constraint>
                        <step-constraint>**MUST** present the EXACT options listed in the template</step-constraint>
                        <step-constraint>**MUST** include recommendations when specified in the template</step-constraint>
                        <step-constraint>**MUST NOT** ask all questions simultaneously</step-constraint>
                        <step-constraint>**MUST NOT** assume answers or provide defaults</step-constraint>
                        <step-constraint>**MUST NOT** skip questions or change their order</step-constraint>
                        <step-constraint>**MUST** follow question sequence: JSpecify → Enhanced Compiler Analysis (conditional)</step-constraint>
                        <step-constraint>**MUST** verify that ALL options from the template are included before asking questions</step-constraint>
                        <step-constraint>**MUST** cross-check question content against the freshly read template file</step-constraint>
                        <step-constraint>**MUST** re-read the template and correct questions if there are discrepancies</step-constraint>
                        <step-constraint>**MUST** STOP and verify all applicable questions have been answered</step-constraint>
                        <step-constraint>**MUST NOT** proceed to Step 3 until complete responses received</step-constraint>
                        <step-constraint>**MUST** confirm understanding of user selections before implementation</step-constraint>
                    </step-constraint-list>
                </step-constraints>
            </step>
            <step number="3">
                <step-title>Conditional Dependency Configuration</step-title>
                <step-content><![CDATA[
Based on user responses, implement the dependency configuration following this order:

**Properties Configuration**: Add version properties for selected dependencies.

```xml
<properties>
    <!-- Core Java Properties -->
    <java.version>24</java.version>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>

    <maven-plugin-compiler.version>3.14.0</maven-plugin-compiler.version>

    <!-- Dependency Versions (add only if selected) -->
    <jspecify.version>1.0.0</jspecify.version>
    <error-prone.version>2.35.1</error-prone.version>
    <nullaway.version>0.12.0</nullaway.version>
    <vavr.version>0.10.6</vavr.version>
</properties>
```

**Dependency Strategy**: Add only essential dependencies that enhance code quality, safety, and functional programming capabilities.

**JSpecify Dependency** (add only if selected):
```xml
<dependencies>
    <dependency>
        <groupId>org.jspecify</groupId>
        <artifactId>jspecify</artifactId>
        <version>${jspecify.version}</version>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

**VAVR Dependency** (add only if selected):
```xml
<dependencies>
    <dependency>
        <groupId>io.vavr</groupId>
        <artifactId>vavr</artifactId>
        <version>${vavr.version}</version>
    </dependency>
</dependencies>
```

**Enhanced Compiler Configuration** (add only if JSpecify selected):
If user wants enhanced compiler analysis, update the maven-compiler-plugin configuration:

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <version>${maven-plugin-compiler.version}</version>
    <configuration>
        <release>${java.version}</release>
        <compilerArgs>
            <arg>-Xlint:all</arg>
            <arg>-Werror</arg>
            <!-- Error prone settings-->
            <arg>-XDcompilePolicy=simple</arg>
            <arg>--should-stop=ifError=FLOW</arg>
            <arg>-Xplugin:ErrorProne \
                -Xep:NullAway:ERROR \
                -XepOpt:NullAway:JSpecifyMode=true \
                -XepOpt:NullAway:TreatGeneratedAsUnannotated=true \
                -XepOpt:NullAway:CheckOptionalEmptiness=true \
                -XepOpt:NullAway:HandleTestAssertionLibraries=true \
                -XepOpt:NullAway:AssertsEnabled=true \
                -XepOpt:NullAway:AnnotatedPackages=info.jab.cli
            </arg>
        </compilerArgs>
        <annotationProcessorPaths>
            <path>
                <groupId>com.google.errorprone</groupId>
                <artifactId>error_prone_core</artifactId>
                <version>${error-prone.version}</version>
            </path>
            <path>
                <groupId>com.uber.nullaway</groupId>
                <artifactId>nullaway</artifactId>
                <version>${nullaway.version}</version>
            </path>
        </annotationProcessorPaths>
    </configuration>
</plugin>
```

**JVM Configuration** (create only if enhanced compiler analysis selected):
Create `.mvn/jvm.config` file with:
```
--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED
--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED
--add-opens=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED
--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED
```

**Package Name Update**: Update the `AnnotatedPackages` configuration in the compiler plugin to match your actual project package structure.
                ]]></step-content>
                <step-constraints>
                    <step-constraint-list>
                        <step-constraint>**MUST** add only dependencies that were selected by the user</step-constraint>
                        <step-constraint>**MUST** use `provided` scope for JSpecify dependency</step-constraint>
                        <step-constraint>**MUST** use `compile` scope for VAVR dependency (default scope)</step-constraint>
                        <step-constraint>**MUST** include full Error Prone and NullAway configuration when selected</step-constraint>
                        <step-constraint>**MUST** include `-Xlint:all` and `-Werror` compiler arguments</step-constraint>
                        <step-constraint>**MUST** include `--should-stop=ifError=FLOW` configuration</step-constraint>
                        <step-constraint>**MUST** include full NullAway configuration with `JSpecifyMode=true`, `TreatGeneratedAsUnannotated=true`, etc.</step-constraint>
                        <step-constraint>**MUST** create `.mvn/jvm.config` when enhanced compiler analysis is enabled</step-constraint>
                        <step-constraint>**MUST** update `AnnotatedPackages` to match actual project structure</step-constraint>
                        <step-constraint>**MUST** ask user to confirm package name for NullAway configuration</step-constraint>
                    </step-constraint-list>
                </step-constraints>
            </step>
            <step number="4">
                <step-title>Usage Examples</step-title>
                <step-content><![CDATA[
Only provide examples for dependencies that were actually added based on user selections.

**JSpecify Usage Example** (if added):

```java
import java.util.Objects;

import org.jspecify.annotations.NonNull;

public class ConstructorSimple {
    private final String property1;

    public ConstructorSimple(@NonNull String property1) {
        //Preconditions
        preconditions(property1);

        this.property1 = property1;
    }

    private void preconditions(String property1) {
        if(Objects.isNull(property1)) {
            throw new IllegalArgumentException("Not valid property1");
        }
    }

    public @NonNull String getProperty1() {
        return property1;
    }
}
```

**VAVR Usage Example** (if added):

```java
import io.vavr.control.Try;
import io.vavr.control.Either;
import io.vavr.collection.List;

public class VavrExamples {

    // Try monad for error handling
    public static void tryExample() {
        Try<Integer> success = Try.of(() -> 10 / 2);
        success.onSuccess(System.out::println);
        success.onFailure(System.err::println);

        Try<Integer> failure = Try.of(() -> 10 / 0);
        failure.onSuccess(System.out::println);
        failure.onFailure(System.err::println);
    }

    // Either monad for functional error handling
    public static Either<String, Integer> divide(int a, int b) {
        if (b == 0) {
            return Either.left("Division by zero");
        }
        return Either.right(a / b);
    }

    // Immutable collections
    public static void collectionsExample() {
        List<Integer> numbers = List.of(1, 2, 3, 4, 5);
        List<Integer> doubled = numbers.map(x -> x * 2);
        List<Integer> evens = numbers.filter(x -> x % 2 == 0);

        System.out.println("Original: " + numbers);
        System.out.println("Doubled: " + doubled);
        System.out.println("Evens: " + evens);
    }
}
```

**Build Command Examples** (if enhanced compiler analysis added):
```bash
# Run with enhanced analysis
./mvnw clean compile

# Compile will fail with nullness violations
./mvnw clean compile -Dmaven.compiler.showWarnings=true
```
                ]]></step-content>
            </step>
        </steps>
    </instructions>

    <output-format>
        <output-format-list>
            <output-format-item>Ask questions one by one following the template exactly</output-format-item>
            <output-format-item>Wait for user responses before proceeding</output-format-item>
            <output-format-item>Add only requested dependencies based on user selections</output-format-item>
            <output-format-item>Follow configuration specifications exactly</output-format-item>
            <output-format-item>Update package names in NullAway configuration</output-format-item>
            <output-format-item>Add VAVR dependency only if user selected functional programming support</output-format-item>
            <output-format-item>Provide usage examples only for features that were added</output-format-item>
        </output-format-list>
    </output-format>

    <safeguards>
        <safeguards-list>
            <safeguards-item>Verify changes with the command: `mvn validate` or `./mvnw validate`</safeguards-item>
            <safeguards-item>Always read template files fresh using file_search and read_file tools</safeguards-item>
            <safeguards-item>Never proceed without user confirmation for each step</safeguards-item>
            <safeguards-item>Ensure JSpecify dependency uses `provided` scope</safeguards-item>
            <safeguards-item>Ensure VAVR dependency uses default `compile` scope</safeguards-item>
            <safeguards-item>Test enhanced compiler analysis with a simple build</safeguards-item>
        </safeguards-list>
    </safeguards>
</prompt>
